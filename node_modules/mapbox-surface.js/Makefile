BROWSERIFY = node_modules/.bin/browserify
UGLIFY = ./node_modules/.bin/uglifyjs

all: dist/mapbox.surface.js dist/mapbox.surface.min.js

D3_FILES = \
	node_modules/d3/src/start.js \
	node_modules/d3/src/arrays/index.js \
	node_modules/d3/src/core/index.js \
	node_modules/d3/src/svg/index.js \
	node_modules/d3/src/xhr/index.js \
	node_modules/d3/src/end.js

lib/d3_custom.js: $(D3_FILES)
	node_modules/.bin/smash $(D3_FILES) | $(UGLIFY) > $@

node_modules/.install: package.json
	npm install && touch node_modules/.install

dist:
	mkdir -p dist

dist/mapbox.surface.js: node_modules/.install dist $(shell $(BROWSERIFY) --list index.js)
	$(BROWSERIFY) --debug index.js > $@

dist/mapbox.surface.min.js: node_modules/.install dist $(shell $(BROWSERIFY) --list index.js)
	$(BROWSERIFY) index.js | $(UGLIFY) --compress --mangle > $@

clean:
	rm -f dist/*.js